---
title: HTTP2帧
author: tyk
date: 2018-06-28 16:46:40
tags:
---
## HTTP2帧

HTTP2一个重要的变化就是引入了帧。帧是HTTP2通信的最小单位，一个HTTP消息有多个帧组成。HTTP2还对帧进行了细分，有HEADERS帧、DATA帧等。

所有帧的头部结构都是一样的，共 9 bytes。
```
+-----------------------------------------------+
|                 Length (24)                   |
+---------------+---------------+---------------+
|   Type (8)    |   Flags (8)   |
+-+-------------+---------------+-------------------------------+
|R|                 Stream Identifier (31)                      |
+=+=============================================================+
|                   Frame Payload (0...)                      ...
+---------------------------------------------------------------+
```

- Length： 24 bits
    
    帧的载荷（不包括头部的9 bytes）。除非`SETTINGS_MAX_FRAME_SIZE`设置有更大值，否则不能大于2^14（16,384）2kb。

- Type： 8 bits

    帧类型，未知类型会被丢弃。

- Flags：8 bits

    具体帧的标识。

- R：1 bits

    预留。

- Stream Identifier：31 bits

    流ID。

### DATA
DATA帧的type为`0x00`，作为消息的载体。

```
+---------------+
|Pad Length? (8)|
+---------------+-----------------------------------------------+
|                            Data (*)                         ...
+---------------------------------------------------------------+
|                           Padding (*)                       ...
+---------------------------------------------------------------+
```

- Pad Length： 8 bits

    对齐数据的长度，仅当设置了`PADDED`flag时才存在。

- Data

    数据

- Padding： 

    对齐填充

DATA帧定义了两个 flag：
- END_STREAM (0x1)

    表示这个帧是当前流的最后一帧。

- PADDED (0x8) 

    表示这个帧有填充。

### HEADERS
HEADERS帧的type为`0x01`，作为消息头的载体。

```
+---------------+
|Pad Length? (8)|
+-+-------------+-----------------------------------------------+
|E|                 Stream Dependency? (31)                     |
+-+-------------+-----------------------------------------------+
|  Weight? (8)  |
+-+-------------+-----------------------------------------------+
|                   Header Block Fragment (*)                 ...
+---------------------------------------------------------------+
|                           Padding (*)                       ...
+---------------------------------------------------------------+
```

- Pad Length： 8 bits

    对齐数据的长度，仅当设置了`PADDED`flag时才存在。

- E：1 bit

    表明流依赖是排他的。这个字段是可选的，只有在设置了`PRIORITY`标志位时才有。

- Stream Dependency：31 bits

    表示当前流依赖的那个流，即当前流的“父亲流”。这个字段是可选的，只有在设置了`PRIORITY`标志位时才有。

- Weight：8 bits

    表示流的优先级权重，范围是1-256之间。这个字段是可选的，只有在设置了`PRIORITY`标志位时才有。

- Header Block Fragment

    头部数据。

- Padding

    对齐数据

DATA帧定义了4个flag：

- END_STREAM (0x1)

    设置此标志位时表明当前帧是端点在流上发送的最后一个帧。

- END_HEADERS (0x4)


        
- PADDED (0x8)

    设置此标志位时表明帧中包含"填充长度"和"填充字节"字段。
    
- PRIORITY (0x20)

    设置此字段时表明帧中包含"排他标志位"、"流依赖"和"权重"字段。

### PRIORITY
PRIORITY帧的type为`0x02`，表示流的优先级。

```
+-+-------------------------------------------------------------+
|E|                  Stream Dependency (31)                     |
+-+-------------+-----------------------------------------------+
|   Weight (8)  |
+-+-------------+
```

- E：1 bit

    表明流依赖是排他的。

- Stream Dependency：31 bits

    31比特位的流标志位，表示当前流依赖的那个流，即当前流的"父亲流"。

- Weight：8 bits

    表示流的优先级权重，范围是1-256之间。

### RST_STREAM
重置帧 (type=0x3)
```
+---------------------------------------------------------------+
|                        Error Code (32)                        |
+---------------------------------------------------------------+
```

### SETTINGS
SETTINGS帧（设置帧，类型是0x4）传递影响两端通信的配置参数

SETTINGS帧payload包含零个或者多个参数。
```
+-------------------------------+
|       Identifier (16)         |
+-------------------------------+-------------------------------+
|                        Value (32)                             |
+---------------------------------------------------------------+
|       Identifier (16)         |
+-------------------------------+-------------------------------+
|                        Value (32)                             |
+---------------------------------------------------------------+
|      ...                      |
+-------------------------------+-------------------------------+
```
- SETTINGS_HEADER_TABLE_SIZE (0x1)

    通知接收者报头表的字节数最大值，报头块解码使用；初始值为4096个字节，默认可不用设置。

- SETTINGS_ENABLE_PUSH (0x2)

    这个设置可以用于禁止服务端推送。0：禁止服务器推送，1：允许推送；其它值非法，PROTOCOL_ERROR错误。

- SETTINGS_MAX_CONCURRENT_STREAMS (0x3)

    发送者允许可打开流的最大值，建议值100，默认可不用设置；0值为禁止创建新流

- SETTINGS_INITIAL_WINDOW_SIZE (0x4)

    发送端流控窗口大小，默认值2^16-1 (65,535)个字节大小；最大值为2^31-1个字节大小，若溢出需要报FLOW_CONTROL_ERROR错误 。

- SETTINGS_MAX_FRAME_SIZE (0x5)
    
    单帧负载最大值，默认为2^14（16384）个字节，两端所发送帧都会收到此设定影响；值区间为2^14（16384）- 2^24-1(16777215)。 

- SETTINGS_MAX_HEADER_LIST_SIZE (0x6)
    
    发送端通告自己准备接收的报头集合最大值，即字节数。此值依赖于未压缩报头字段，包含字段名称、字段值以及每一个报头字段的32个字节的开销等。

### PUSH_PROMISE
送承诺帧，类型是0x5。

    
### PING
PING帧（类型是0x6）是一种从发送方测量最小往返时间的机制，也是一种检测空闲连接是否可用的机制。
```
+---------------------------------------------------------------+
|                                                               |
|                      Opaque Data (64)                         |
|                                                               |
+---------------------------------------------------------------+
```

### GOAWAY

### WINDOW_UPDATE

### CONTINUATION



### 参考
- [Hypertext Transfer Protocol Version 2 (HTTP/2)](https://httpwg.org/specs/rfc7540.html)
- [Web性能权威指南](https://book.douban.com/subject/25856314/)
- [HTTP/2笔记之帧](http://www.blogjava.net/yongboy/archive/2015/03/20/423655.html)