---
title: HTTP2帧
author: tyk
date: 2018-06-28 16:46:40
tags:
---
## HTTP2帧

HTTP2一个重要的变化就是引入了帧。帧是HTTP2通信的最小单位，一个HTTP消息有多个帧组成。HTTP2还对帧进行了细分，有HEADERS帧、DATA帧等。

所有帧的头部结构都是一样的，共 9 bytes。
```
+-----------------------------------------------+
|                 Length (24)                   |
+---------------+---------------+---------------+
|   Type (8)    |   Flags (8)   |
+-+-------------+---------------+-------------------------------+
|R|                 Stream Identifier (31)                      |
+=+=============================================================+
|                   Frame Payload (0...)                      ...
+---------------------------------------------------------------+
```

- Length： 24 bits
    
    帧的载荷（不包括头部的9 bytes）。除非`SETTINGS_MAX_FRAME_SIZE`设置有更大值，否则不能大于2^14（16,384）。

- Type： 8 bits

    帧类型，未知类型会被丢弃。

- Flags：8 bits

    具体帧的标识。

- R：1 bits

    预留。

- Stream Identifier：31 bits

    流ID。

### DATA
DATA帧的type为`0x00`，作为消息的载体。

```
+---------------+
|Pad Length? (8)|
+---------------+-----------------------------------------------+
|                            Data (*)                         ...
+---------------------------------------------------------------+
|                           Padding (*)                       ...
+---------------------------------------------------------------+
```

- Pad Length： 8 bits

    对齐数据的长度，仅当设置了`PADDED`flag时才存在。

- Data

    数据

- Padding： 

    对齐填充

DATA帧定义了两个flag：
- END_STREAM (0x1)

    表示这个帧是当前流的最后一帧。

- PADDED (0x8) 

    表示这个帧有填充。

### HEADERS
HEADERS帧的type为`0x01`，作为消息头的载体。

```
+---------------+
|Pad Length? (8)|
+-+-------------+-----------------------------------------------+
|E|                 Stream Dependency? (31)                     |
+-+-------------+-----------------------------------------------+
|  Weight? (8)  |
+-+-------------+-----------------------------------------------+
|                   Header Block Fragment (*)                 ...
+---------------------------------------------------------------+
|                           Padding (*)                       ...
+---------------------------------------------------------------+
```

- Pad Length： 8 bits

    对齐数据的长度，仅当设置了`PADDED`flag时才存在。

- E：1 bit

- Stream Dependency：31 bits

- Weight：8 bits

- Header Block Fragment

    头部数据

- Padding

    对齐

DATA帧定义了4个flag：

- END_STREAM (0x1)
- END_HEADERS (0x4)
- PADDED (0x8)
- PRIORITY (0x20)

### PRIORITY
HEADERS帧的type为`0x02`，表示流的优先级。

```
+-+-------------------------------------------------------------+
|E|                  Stream Dependency (31)                     |
+-+-------------+-----------------------------------------------+
|   Weight (8)  |
+-+-------------+
```

### RST_STREAM
 (type=0x3)
```
+---------------------------------------------------------------+
|                        Error Code (32)                        |
+---------------------------------------------------------------+
```

### SETTINGS
 (type=0x4) 

SETTINGS帧payload包含零个或者多个参数。
```
+-------------------------------+
|       Identifier (16)         |
+-------------------------------+-------------------------------+
|                        Value (32)                             |
+---------------------------------------------------------------+
```
- SETTINGS_HEADER_TABLE_SIZE (0x1)
- SETTINGS_ENABLE_PUSH (0x2)
- SETTINGS_MAX_CONCURRENT_STREAMS (0x3)

### PUSH_PROMISE

### PING

### GOAWAY

### WINDOW_UPDATE

### CONTINUATION



### 参考
- [Hypertext Transfer Protocol Version 2 (HTTP/2)](https://httpwg.org/specs/rfc7540.html)
- [Web性能权威指南](https://book.douban.com/subject/25856314/)
